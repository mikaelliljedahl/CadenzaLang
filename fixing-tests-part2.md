# Next Steps for Fixing Tests

This document outlines the remaining work to get the test suite passing.

## Summary of Failures

The test run shows several categories of failures:

1.  **Golden File Mismatches**: The generated C# code for some tests does not match the "golden" files. This is happening for `GoldenFile_EffectSystem_ShouldMatch` and `GoldenFile_ResultTypes_ShouldMatch`.
2.  **Compilation Errors in Generated Code**: The C# code generated by the transpiler has compilation errors. This is the root cause of many failures, including `GoldenFile_EffectSystem_ShouldMatch`, `GoldenFile_ResultTypes_ShouldMatch`, and `Regression_GeneratedCodeCompilation`. The main error is: `The type arguments for method \'Result.Ok<T, E>(T)\' cannot be inferred from the usage. Try specifying the type arguments explicitly.`
3.  **Assertion Failures in Unit Tests**: Several unit tests in `CodeGeneratorTests.cs` are failing. These seem to be caused by the same root issue: the generated code is not what the test expects.
4.  **Regression Test Failures**: The `Regression_PreventBreakingChanges` test is failing, indicating that the output of the transpiler has changed for some core functionality.
5.  **NUnit Engine Exception**: There's a `System.IO.FileNotFoundException` happening within the NUnit engine itself. This might be a configuration issue or a problem with how the tests are being run.

## Plan of Action

Here's a recommended approach to tackle these issues:

### 1. Fix the `Result.Ok<T, E>` Type Inference Issue

This is the most critical issue, as it's causing a cascade of failures.

*   **Problem**: The C# compiler cannot infer the generic type arguments for `Result.Ok(value)`.
*   **Location**: The errors point to the generated code. This means the issue is in the `CodeGenerator.cs` file.
*   **Suggestion**: When generating calls to `Result.Ok()` and `Result.Error()`, the transpiler needs to explicitly specify the type arguments.

    For example, instead of generating:
    ```csharp
    return Result.Ok(42);
    ```
    It should generate:
    ```csharp
    return Result.Ok<int, string>(42);
    ```
    The `string` type for the error part of the `Result` will need to be inferred from the function's return type signature.

### 2. Address the `CodeGenerator.cs` Unit Test Failures

Once the type inference issue is resolved, many of the `CodeGeneratorTests.cs` failures should be fixed. The remaining failures in this file should be addressed next.

*   `CodeGenerator_ShouldGenerateComplexStringInterpolation`: The test expects `string.Format`, but the generator is producing C# 6 string interpolation (`$""`). The test should be updated to reflect the new, better output.
*   `CodeGenerator_ShouldGenerateImportStatements`: The test expects `using Math;`, but the generator is producing `using Cadenza.Modules.Math;`. This is likely a change in the expected output format. The test should be updated.
*   `CodeGenerator_ShouldGenerateQualifiedFunctionCall`: Similar to the import statement test, the expected output `MathModule.add(1, 2)` does not match the actual output `Math.add(1, 2)`. The test needs to be updated.
*   `CodeGenerator_ShouldGenerateXmlDocumentation`: The generated code is missing the `/// <summary>` XML documentation. The code generator needs to be fixed to add this.
*   `CodeGenerator_ShouldHandleComplexOperatorPrecedence`: The generated code has extra parentheses `(a + b * c) > d` which is functionally correct, but the test expects `a + b * c > d`. The test should be made less strict or the generator should be changed to produce the exact output.

### 3. Update Golden Files

After fixing the code generation, the golden files will need to be updated.

*   Run the tests with a special flag or environment variable to regenerate the golden files. The `GoldenFileTests.cs` file should have information on how to do this. Look for a method like `UpdateGoldenFile`.

### 4. Investigate the NUnit `FileNotFoundException`

This is a separate issue that might be related to the test runner or environment.

*   **Suggestion**: Check the `Cadenza.Tests.csproj` file for any unusual configurations. Try running the tests with the `--diag` flag to get more detailed output from the test runner: `dotnet test --diag:log.txt`. This might provide more clues.

Good luck!
