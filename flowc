#!/bin/bash

# FlowLang Compiler Wrapper
# Routes to flowc-core for basic compilation, tools for advanced features

# Build core compiler if not already built
if [ ! -f "core/bin/Debug/net8.0/flowc-core.dll" ]; then
    echo "Building FlowLang core compiler..."
    cd core && dotnet build flowc-core.csproj >/dev/null
    if [ $? -ne 0 ]; then
        echo "Error: Failed to build core compiler"
        exit 1
    fi
    cd ..
fi

# Function to run core compiler
run_core() {
    local orig_dir=$(pwd)
    cd core
    # Convert relative paths to absolute from original directory
    local args=()
    for arg in "$@"; do
        if [[ "$arg" == *.flow ]] && [[ ! "$arg" == /* ]]; then
            args+=("$orig_dir/$arg")
        else
            args+=("$arg")
        fi
    done
    dotnet run -- "${args[@]}"
    cd "$orig_dir"
}

# Parse command and arguments
if [ $# -eq 0 ]; then
    echo "FlowLang Compiler Toolchain"
    echo ""
    echo "Usage:"
    echo "  flowc <input.flow> <output.cs>              # Compile to C#"
    echo "  flowc compile <input.flow> <output.cs>      # Explicit compile"
    echo "  flowc compile --target js <input.flow> <output.js>  # Compile to JavaScript"
    echo "  flowc dev [--port 8080]                     # Start development server (TODO)"
    echo "  flowc lint <files...>                       # Run linter (TODO)"
    echo "  flowc --help                                # Show help"
    echo "  flowc --version                             # Show version"
    echo ""
    echo "Core compiler commands:"
    run_core --help
    exit 0
fi

case "$1" in
    "--help" | "-h")
        run_core --help
        ;;
    "--version" | "-v")
        echo "FlowLang Toolchain v1.0.0"
        run_core --version
        ;;
    "compile")
        shift
        run_core "$@"
        ;;
    "dev")
        echo "ðŸš§ Development server not yet implemented in pure FlowLang"
        echo "Use the old flowc for now: src/flowc.cs dev"
        exit 1
        ;;
    "lint")
        echo "ðŸš§ Linter not yet implemented in pure FlowLang"
        echo "Use the old flowc for now: src/flowc.cs lint"
        exit 1
        ;;
    "lsp")
        echo "ðŸš§ Language server not yet implemented in pure FlowLang"
        echo "Use the old flowc for now: src/flowc.cs lsp"
        exit 1
        ;;
    *)
        # Default: treat as input/output files for compilation
        run_core "$@"
        ;;
esac